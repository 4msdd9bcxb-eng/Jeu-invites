<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIDOUX â€“ Pluie de sous</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2e; --line:#223055; --ink:#eaf0ff; --btn:#0b1220; --btnLine:#2a3c6b;
    }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:12px; display:flex; flex-direction:column; gap:10px;
      border-bottom:1px solid var(--line); background:var(--panel);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{font-weight:800; font-size:15px;}
    .controls{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--btnLine); background:var(--btn); color:var(--ink);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:700; font-size:14px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:scale(.98)}
    .wrap{flex:1; display:flex; align-items:stretch; justify-content:center; padding:10px;}
    pre{
      margin:0; width:100%;
      max-width: 720px;
      border:1px solid var(--line); border-radius:14px;
      padding:12px;
      line-height:1.05;
      font-size: 16px;      /* ðŸ‘ˆ mobile-first */
      overflow:hidden;
      white-space:pre;
      user-select:none;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .hint{
      opacity:.7; font-size:12px; padding:0 12px 12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div class="title">ðŸ’° BIDOUX (pluie de sous)</div>
      <button class="btn" id="lock">Verrouiller</button>
    </div>
    <div class="controls">
      <button class="btn" id="speedDown">- vitesse</button>
      <button class="btn" id="speedUp">+ vitesse</button>
      <button class="btn" id="toggle">Pause</button>
      <button class="btn" id="less">Moins</button>
      <button class="btn" id="more">Plus</button>
    </div>
  </header>

  <div class="wrap">
    <pre id="screen"></pre>
  </div>
  <div class="hint">Mobile-first : lisible sur iPhone. (Boutons seulement, pas besoin de clavier)</div>

  <script>
    // AccÃ¨s (statique, cÃ´tÃ© navigateur)
    if (localStorage.getItem("coin_access") !== "ok") {
      window.location.href = "index.html";
    }

    const screenEl = document.getElementById("screen");

    // ðŸ‘‡ Mobile-first : on limite volontairement la largeur en caractÃ¨res
    function computeSize(){
      // largeur en "caractÃ¨res" approximÃ©e Ã  partir du viewport
      const wChars = Math.max(44, Math.min(70, Math.floor(window.innerWidth / 9))); // iPhone â‰ˆ 44-52
      const hLines = Math.max(20, Math.min(32, Math.floor((window.innerHeight - 180) / 18)));
      return {W:wChars, H:hLines};
    }
    let {W,H} = computeSize();
    window.addEventListener("resize", ()=>{ ({W,H}=computeSize()); rebuild(); });

    // PiÃ¨ces (simples, trÃ¨s lisibles)
    const coins = ["o","O","0","$","Â¢"];
    const weights = [6,3,3,2,1];
    function pickCoin(){
      const sum = weights.reduce((a,b)=>a+b,0);
      let r = Math.random()*sum;
      for (let i=0;i<coins.length;i++){
        r -= weights[i];
        if (r<=0) return coins[i];
      }
      return "o";
    }

    // Police 7 lignes : BIDOUX (pixels)
    const FONT = {
      "B":[ "#### ","#   #","#   #","#### ","#   #","#   #","#### " ],
      "I":[ "#####","  #  ","  #  ","  #  ","  #  ","  #  ","#####" ],
      "D":[ "#### ","#   #","#   #","#   #","#   #","#   #","#### " ],
      "O":[ " #### ","#    #","#    #","#    #","#    #","#    #"," #### " ],
      "U":[ "#   #","#   #","#   #","#   #","#   #","#   #"," ### " ],
      "X":[ "#   #"," # # ","  #  ","  #  ","  #  "," # # ","#   #" ],
      " ":[ "  ","  ","  ","  ","  ","  ","  " ]
    };
    const WORD = "BIDOUX";
    const CHAR_SP = 2;
    const targetHeight = 7;

    let targetMask = [];
    let targetCols = [];
    let filled = new Map(); // "x,y" -> ttl
    const keyXY = (x,y)=>x+","+y;

    // Animation
    let drops = []; // {x,y,ch,vy}
    let frameMs = 85;          // ðŸ‘ˆ mobile-first : un peu plus lent, plus stable
    let paused = false;

    // IntensitÃ©s (ajustables par boutons)
    let backgroundRain = 0.010; // lÃ©ger
    let targetRainBoost = 0.18; // fort sur le mot

    function buildMask(){
      const lines = Array.from({length: targetHeight}, ()=>"");
      for (const ch of WORD){
        const g = FONT[ch];
        for (let i=0;i<targetHeight;i++){
          lines[i] += g[i] + " ".repeat(CHAR_SP);
        }
      }
      const wordWidth = lines[0].length;

      const targetLeft = Math.max(0, Math.floor((W - wordWidth)/2));
      const targetTop  = Math.max(2, Math.floor((H - targetHeight)/3));

      targetMask = [];
      const colsSet = new Set();

      for (let y=0;y<targetHeight;y++){
        for (let x=0;x<lines[y].length;x++){
          if (lines[y][x] === "#"){
            const gx = targetLeft + x;
            const gy = targetTop + y;
            if (gx>=0 && gx<W && gy>=0 && gy<H-1){
              targetMask.push({x:gx, y:gy});
              colsSet.add(gx);
            }
          }
        }
      }
      targetCols = [...colsSet];
    }

    function rebuild(){
      drops = [];
      filled.clear();
      buildMask();
    }
    rebuild();

    function spawn(){
      // Fond
      for (let x=0;x<W;x++){
        if (Math.random() < backgroundRain){
          drops.push({x, y:0, ch: pickCoin(), vy: 0.95 + Math.random()*0.55});
        }
      }
      // Colonnes du mot
      for (const x of targetCols){
        if (Math.random() < targetRainBoost){
          drops.push({x, y:0, ch: pickCoin(), vy: 1.00 + Math.random()*0.70});
        }
      }
      if (drops.length > 1200) drops.splice(0, drops.length - 1200);
    }

    function step(){
      if (!paused){
        spawn();

        for (const d of drops){
          d.y += d.vy;
          if (d.y > H-2){
            d.y = H-2;
            d.vy = 0;
          }
          // Si Ã§a passe sur un pixel du mot, on â€œallumeâ€ ce pixel
          const x = Math.round(d.x);
          const y = Math.round(d.y);
          const k = keyXY(x,y);
          // On ne check que si on est dans la zone (simple et rapide)
          if (filled.has(k) || false){
            // dÃ©jÃ  allumÃ© -> rallume
            filled.set(k, 14);
          }
        }

        // Garantit lisibilitÃ© : rallume quelques pixels alÃ©atoires Ã  chaque frame
        for (let i=0;i<6;i++){
          const p = targetMask[Math.floor(Math.random()*targetMask.length)];
          filled.set(keyXY(p.x,p.y), 14 + (Math.random()*10|0));
        }

        // TTL
        for (const [k, ttl] of filled){
          if (ttl <= 1) filled.delete(k);
          else filled.set(k, ttl - 1);
        }

        // Nettoyage des piÃ¨ces au sol
        drops = drops.filter(d => !(d.y >= H-2 && Math.random() < 0.035));

        render();
      }
      setTimeout(step, frameMs);
    }

    function render(){
      const buf = Array.from({length:H}, ()=>Array(W).fill(" "));

      // Sol
      for (let x=0;x<W;x++) buf[H-1][x] = "=";

      // Drops
      for (const d of drops){
        const x = Math.round(d.x), y = Math.round(d.y);
        if (y>=0 && y<H-1 && x>=0 && x<W) buf[y][x] = d.ch;
      }

      // BIDOUX en â€œpiÃ¨cesâ€ (surcouche nette)
      for (const p of targetMask){
        const k = keyXY(p.x,p.y);
        if (filled.has(k)) buf[p.y][p.x] = "$";
      }

      // Petit bandeau en haut
      const label = "  $$$  BIDOUX  $$$  ";
      for (let i=0;i<label.length && i<W;i++) buf[0][i] = label[i];

      screenEl.textContent = buf.map(r=>r.join("")).join("\n");
    }

    // UI
    function lock(){
      localStorage.removeItem("coin_access");
      window.location.href = "index.html";
    }
    document.getElementById("lock").addEventListener("click", lock);

    document.getElementById("speedUp").addEventListener("click", () => frameMs = Math.max(25, frameMs - 10));
    document.getElementById("speedDown").addEventListener("click", () => frameMs = Math.min(220, frameMs + 10));

    document.getElementById("toggle").addEventListener("click", () => {
      paused = !paused;
      document.getElementById("toggle").textContent = paused ? "Reprendre" : "Pause";
    });

    document.getElementById("more").addEventListener("click", () => {
      backgroundRain = Math.min(0.03, backgroundRain + 0.003);
      targetRainBoost = Math.min(0.30, targetRainBoost + 0.02);
    });
    document.getElementById("less").addEventListener("click", () => {
      backgroundRain = Math.max(0.002, backgroundRain - 0.003);
      targetRainBoost = Math.max(0.08, targetRainBoost - 0.02);
    });

    // Start
    step();
  </script>
</body>
</html>
